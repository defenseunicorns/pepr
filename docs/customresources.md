# Importing Custom Resources

Pepr and the [Kubernetes Fluent Client](https://github.com/defenseunicorns/kubernetes-fluent-client) allow us to generate TypeScript typings from Kubernetes Custom Resource Definitions (CRDs). This enables Pepr to interact with custom resources as if they were native Kubernetes resources, empowering users to go beyond standard Kubernetes resources, enabling them to interact with custom entities such as Istio's Gateways and VirtualServices.


## Generating TypeScript Types from CRDs

To produce a new type, employ the kubernetes-fluent-client CLI.

```bash
npx kubernetes-fluent-client crd [source] [directory]
```

The `crd` commands expects a `[source]`, which can be a URL or local file containing the `CustomResourceDefinition(s)`, and a `[directory]` where the generated code will live.

The following example creates types for the Istio CRDs:

```bash
┌─[cmwylie19@Cases-MacBook-Pro] - [/custom_istio_operator] - [2023-10-16 05:46:24]
└─[0] <> npx kubernetes-fluent-client crd https://raw.githubusercontent.com/istio/istio/master/manifests/charts/base/crds/crd-all.gen.yaml crds
Need to install the following packages:
  kubernetes-fluent-client@1.6.1
Ok to proceed? (y) y
Attempting to load https://raw.githubusercontent.com/istio/istio/master/manifests/charts/base/crds/crd-all.gen.yaml as a URL

- Generating extensions.istio.io/v1alpha1 types for WasmPlugin
- Generating networking.istio.io/v1alpha3 types for DestinationRule
- Generating networking.istio.io/v1beta1 types for DestinationRule
- Generating networking.istio.io/v1alpha3 types for EnvoyFilter
- Generating networking.istio.io/v1alpha3 types for Gateway
- Generating networking.istio.io/v1beta1 types for Gateway
- Generating networking.istio.io/v1beta1 types for ProxyConfig
- Generating networking.istio.io/v1alpha3 types for ServiceEntry
- Generating networking.istio.io/v1beta1 types for ServiceEntry
- Generating networking.istio.io/v1alpha3 types for Sidecar
- Generating networking.istio.io/v1beta1 types for Sidecar
- Generating networking.istio.io/v1alpha3 types for VirtualService
- Generating networking.istio.io/v1beta1 types for VirtualService
- Generating networking.istio.io/v1alpha3 types for WorkloadEntry
- Generating networking.istio.io/v1beta1 types for WorkloadEntry
- Generating networking.istio.io/v1alpha3 types for WorkloadGroup
- Generating networking.istio.io/v1beta1 types for WorkloadGroup
- Generating security.istio.io/v1 types for AuthorizationPolicy
- Generating security.istio.io/v1beta1 types for AuthorizationPolicy
- Generating security.istio.io/v1beta1 types for PeerAuthentication
- Generating security.istio.io/v1 types for RequestAuthentication
- Generating security.istio.io/v1beta1 types for RequestAuthentication
- Generating telemetry.istio.io/v1alpha1 types for Telemetry

✅ Generated 23 files in the istio directory
```

We observe that the `kubernetes-fluent-client` has produced the TypeScript types within the `crds` directory. These types can now be utilized in the Pepr module.

```typescript
┌─[cmwylie19@Cases-MacBook-Pro] - [/custom_istio_operator] - [2023-10-16 05:46:38]
└─[0] <> cat crds/proxyconfig-v1beta1.ts
// This file is auto-generated by kubernetes-fluent-client, do not edit manually

import { GenericKind, RegisterKind } from "kubernetes-fluent-client";

export class ProxyConfig extends GenericKind {
    /**
     * Provides configuration for individual workloads. See more details at:
     * https://istio.io/docs/reference/config/networking/proxy-config.html
     */
    spec?:   Spec;
    status?: { [key: string]: any };
}

/**
 * Provides configuration for individual workloads. See more details at:
 * https://istio.io/docs/reference/config/networking/proxy-config.html
 */
export interface Spec {
    /**
     * The number of worker threads to run.
     */
    concurrency?: number;
    /**
     * Additional environment variables for the proxy.
     */
    environmentVariables?: { [key: string]: string };
    /**
     * Specifies the details of the proxy image.
     */
    image?: Image;
    /**
     * Optional.
     */
    selector?: Selector;
}

/**
 * Specifies the details of the proxy image.
 */
export interface Image {
    /**
     * The image type of the image.
     */
    imageType?: string;
}

/**
 * Optional.
 */
export interface Selector {
    /**
     * One or more labels that indicate a specific set of pods/VMs on which a policy should be
     * applied.
     */
    matchLabels?: { [key: string]: string };
}

RegisterKind(ProxyConfig, {
  group: "networking.istio.io",
  version: "v1beta1",
  kind: "ProxyConfig",
});
```

## Using new types

The generated types can be imported into Pepr. This can be achieved by incorporating the generated files into the capability. For instance, to integrate Istio's `ProxyConfig` type into the `hello-pepr` capability, you should include the pertinent sections of the generated file. Specifically, Pepr requires the `class`, its associated types, and registry details. Once set up, you can manage the `ProxyConfig` as seamlessly as any other resource.

```typescript
import {
  Capability,
  K8s,
  Log,
  PeprMutateRequest,
  RegisterKind,
  a,
  fetch,
  fetchStatus,
  kind,
} from "pepr";


export const HelloPepr = new Capability({
  name: "hello-pepr",
  description: "A simple example capability to show how things work.",
  namespaces: ["pepr-demo", "pepr-demo-2"],
});

// Use the 'When' function to create a new action, use 'Store' to persist data
const { When, Store } = HelloPepr;

export class ProxyConfig extends a.GenericKind {
  /**
   * Provides configuration for individual workloads. See more details at:
   * https://istio.io/docs/reference/config/networking/proxy-config.html
   */
  spec?: Spec;
  status?: { [key: string]: any };
}

/**
 * Provides configuration for individual workloads. See more details at:
 * https://istio.io/docs/reference/config/networking/proxy-config.html
 */
export interface Spec {
  /**
   * The number of worker threads to run.
   */
  concurrency?: number;
  /**
   * Additional environment variables for the proxy.
   */
  environmentVariables?: { [key: string]: string };
  /**
   * Specifies the details of the proxy image.
   */
  image?: Image;
  /**
   * Optional.
   */
  selector?: Selector;
}

/**
 * Specifies the details of the proxy image.
 */
export interface Image {
  /**
   * The image type of the image.
   */
  imageType?: string;
}

/**
 * Optional.
 */
export interface Selector {
  /**
   * One or more labels that indicate a specific set of pods/VMs on which a policy should be
   * applied.
   */
  matchLabels?: { [key: string]: string };
}

RegisterKind(ProxyConfig, {
  group: "networking.istio.io",
  version: "v1beta1",
  kind: "ProxyConfig",
});

// Use ProxyConfig as you would any other resource
When(ProxyConfig)
  .IsCreated()
  .Mutate(pc => pc.SetAnnotation("pepr.dev", "was-here"));
```
