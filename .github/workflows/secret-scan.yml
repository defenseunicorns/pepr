name: secret-scan
on: 
  pull_request:
    branches:
      - main
    paths-ignore:
    - "LICENSE"
    - "CODEOWNERS"

permissions:  # added using https://github.com/step-security/secure-repo
  contents: read
  
jobs:
  secret-scan: # scan for any live secrets in the repository using trufflehog
    runs-on: ubuntu-latest
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
      with:
        egress-policy: audit
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        fetch-depth: 0
    - name: Default Secret Scanning
      uses: trufflesecurity/trufflehog@ed6d045b46642d0d94a60bdf9b1246aefbcf3d35 # main
      with:
        extra_args: --debug --only-verified --json
      continue-on-error: true

    - name: Filter Results by Date
      shell: bash
      run: |
        mkdir -p /tmp/trufflehog
        
        # Process each line of the output
        ${{ steps.scan.outputs.command }} | while read -r line; do
          # Extract timestamp from each JSON object
          timestamp=$(echo "$line" | jq -r '.SourceMetadata.Data.Github.timestamp // empty')
          
          # Check if timestamp exists and is after Aug 1, 2025
          if [ -n "$timestamp" ]; then
            # Convert timestamp to epoch seconds for comparison
            ts_seconds=$(date -d "$timestamp" +%s 2>/dev/null || date -j -f "%Y-%m-%d %H:%M:%S %z" "$timestamp" +%s 2>/dev/null)
            cutoff_seconds=$(date -d "2025-08-01" +%s 2>/dev/null || date -j -f "%Y-%m-%d" "2025-08-01" +%s 2>/dev/null)
            
            # If timestamp is after cutoff, output the result
            if [ "$ts_seconds" -gt "$cutoff_seconds" ]; then
              echo "$line" >> /tmp/trufflehog/filtered_results.json
            fi
          fi
        done
        
        # Display and handle results
        if [ -s /tmp/trufflehog/filtered_results.json ]; then
          echo "=== Secrets found after August 1, 2025 ==="
          cat /tmp/trufflehog/filtered_results.json
          echo "::error ::Found secrets after August 1, 2025!"
          exit 1
        else
          echo "No secrets found after August 1, 2025"
        fi